import groovy.json.JsonOutput
pipeline { 
    environment { 
        PRODUCT_VERSION = "2"  
        SERVICE_A_VERSION= '1.35'  
        SERVICE_B_VERSION= '1.4.6'
        SERVICE_C_VERSION= '1.7.1' 
        REPO_URL = 'https://github.com/norelnorel3/docker-image.git'
    }

    agent {
        kubernetes {
            label 'kubernetes'
            inheritFrom 'default'  // Using the default pod template
        }
    }


    stages {
        stage('Cloning our Git') { 
            steps { 
                git REPO_URL
            }
        } 
    
        stage('Check and update versios file') {
            steps {
                script {
                    dir('version control') {
                        
                    def versionsFile = readFile file: 'versions.json'
                    def versionsJson = readJSON text: versionsFile

                    def lastVersion = versionsJson[-1].product
                    
                    def currentProductVersion = lastVersion.version
                    def currentServiceAVersion = lastVersion.services.service_a
                    def currentServiceBVersion = lastVersion.services.service_b
                    def currentServiceCVersion = lastVersion.services.service_c                                                        

                    if ( currentProductVersion != PRODUCT_VERSION ||
                        currentServiceAVersion != SERVICE_A_VERSION ||
                        currentServiceAVersion != SERVICE_A_VERSION ||
                        currentServiceAVersion != SERVICE_A_VERSION  ) {

                        def newVersion = [
                            "product": [
                                "name": "Product X",
                                "version": env.NEW_VERSION_PRODUCT,
                                "date": env.NEW_DATE,
                                "services": [
                                    "service_a": env.NEW_VERSION_SERVICE_A,
                                    "service_b": env.NEW_VERSION_SERVICE_B,
                                    "service_c": env.NEW_VERSION_SERVICE_C
                                ]
                            ]
                        ]

                        versionsJson <<  newVersion                          
                        writeJSON file: 'versions.json', json: versionsJson

                        echo  "Updated versionsJson content: ${versionsJson}" 

                        }


                }
            }
        }

        
    }
}
}